{% comment %}
  Parameters:
  - product {Object} - Product object.
  - product_form_id {String} - Product form ID.
  - media_ratio {Number} - Media aspect ratio.
  - block {Object} - Block object.
  - update_url {Boolean} - Update the URL when selecting a variant (optional, default is false).
  - dynamic_availability_method {String} - Dynamic availability method, 'downward' or 'selection'.

  Dependencies:
  - Custom select component

  Usage:
  {% render 'variant-picker', product: product, product_form_id: product_form_id, block: block %}
{% endcomment %}

{%- if block.settings.enable_size_chart -%}
  <link rel="stylesheet" href="{{ 'modal.css' | asset_url }}">
{%- endif -%}

<script src="{{ 'variant-picker.js' | asset_url }}" defer="defer"></script>

{%- if block.settings.selector_style == 'dropdown' -%}
  <script src="{{ 'custom-select.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<variant-picker class="no-js-hidden"
                data-url="{{ product.url }}"
                data-update-url="{{ update_url | default: false }}"
                data-show-availability="{{ block.settings.enable_dynamic_availability }}"
                data-availability-method="{{ dynamic_availability_method | default: 'downward' }}">
  {%- for option in product.options_with_values -%}
    {%- capture option_id %}{{ section.id }}-{{ option.name | handle }}{% endcapture -%}
    {%- liquid
      assign is_color_selector = false
      assign is_swatch_style = false
      assign is_native_swatch_style = false
      assign is_variant_image_style = false
      assign show_size_chart = false

      if settings.swatch_source == 'theme' and settings.swatch_option_name contains option.name and settings.variant_picker_color_style == 'variant-images'
        assign is_color_selector = true
        assign is_variant_image_style = true
        assign option_index0 = forloop.index0
      elsif settings.swatch_source == 'theme' and settings.swatch_option_name contains option.name and settings.variant_picker_color_style == 'swatches'
          assign is_color_selector = true
          assign is_swatch_style = true
      else
        assign native_swatch_options = option.values | where: 'swatch'
        if settings.swatch_source == 'native' and native_swatch_options.size > 0
          assign is_color_selector = true
          assign is_swatch_style = true
          assign is_native_swatch_style = true
        endif
      endif

      if block.settings.enable_size_chart and block.settings.size_chart_variant == option.name and block.settings.size_chart_page != blank
        assign show_size_chart = true
      endif
    -%}

    {%- if show_size_chart -%}
      {%- capture size_chart_link -%}
        <modal-opener class="no-js-hidden" data-modal="size-chart">
          <button type="button" class="link block text-sm" aria-haspopup="dialog">
            {{- 'products.product.size_chart' | t -}}
          </button>
        </modal-opener>
        <noscript>
          <a href="{{ block.settings.size_chart_page.url }}" class="link">{{ 'products.product.size_chart' | t }}</a>
        </noscript>
      {%- endcapture -%}
    {%- endif -%}

    {%- if block.settings.selector_style == 'dropdown' and is_variant_image_style == false -%}
      {%- capture selector_label -%}
        <label class="label" id="{{ option_id }}-label">{{- option.name -}}</label>
      {%- endcapture -%}
      <div class="option-selector" data-selector-type="dropdown">
        {%- if show_size_chart -%}
          <div class="flex justify-between">
            {{ selector_label }}
            {{ size_chart_link }}
          </div>
        {%- else -%}
          {{ selector_label }}
        {%- endif -%}
        {% render 'custom-select',
          id: option_id,
          option_values: option.values,
          selected_value: option.selected_value,
          swatches: is_color_selector,
          native_swatches: is_native_swatch_style
        %}
      </div>
    {%- else -%}
      <fieldset class="option-selector" data-selector-type="listed">
        {%- if show_size_chart -%}
          <div class="flex justify-between">
            <legend class="label">{{- option.name -}}</legend>
            {{ size_chart_link }}
          </div>
        {%- else -%}
          <legend class="label">{{- option.name -}}{% if is_color_selector %}: <span class="option-selector__label-value js-color-text">{{ option.selected_value }}</span>{% endif %}</legend>
        {%- endif -%}
        <div class="option-selector__btns flex flex-wrap">
          {%- for value in option.values -%}
            {%- assign value_index0 = forloop.index0 -%}
            <input type="radio" class="opt-btn visually-hidden focus-label js-option" name="{{ option_id }}-option" id="{{ option_id }}-opt-{{ value_index0 }}" value="{{ value | escape }}"{% if option.selected_value == value %} checked{% endif %}>

            {% if is_variant_image_style -%}
              {%- for variant in product.variants -%}
                {%- if variant.options[option_index0] == value -%}
                  <label class="opt-label opt-label--image relative" for="{{ option_id }}-opt-{{ value_index0 }}">
                    <span class="visually-hidden js-value">{{ value }}</span>
                    <div class="opt-label__media media relative" style="padding-top: {% if settings.swatch_shape == 'circle' -%}100{% else %}{{ 100 | divided_by: media_ratio }}{% endif %}%">
                      {%- liquid
                        # Tailwind: object-top object-center object-bottom
                        assign media_class = 'img-fit object-' | append: settings.prod_card_image_position
                        assign image_width = variant.featured_media.aspect_ratio | at_least: 1.0 | times: 64 | ceil
                      -%}
                      {%- render 'image', image: variant.featured_media, src_width: image_width, srcset_2x: true, class: media_class -%}
                    </div>
                  </label>
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}

            {%- elsif settings.swatch_source == 'native' and value.swatch.image -%}
              <label class="opt-label opt-label--swatch btn relative" for="{{ option_id }}-opt-{{ value_index0 }}" data-swatch>
                <span class="visually-hidden js-value">{{ value }}</span>
                <div class="opt-label__native-media media absolute inset-0">
                  {%- assign image_width = value.swatch.image.aspect_ratio | at_least: 1.0 | times: 64 | ceil -%}
                  {%- render 'image', image: value.swatch.image, src_width: image_width, srcset_2x: true, class: 'img-fit' -%}
                </div>
              </label>

            {%- elsif settings.swatch_source == 'native' and value.swatch.color -%}
              <label class="opt-label opt-label--swatch btn relative"
                data-swatch="{{ value | replace: '"', '' | downcase }}"
                for="{{ option_id }}-opt-{{ value_index0 }}"
                style="background-color: rgb({{ value.swatch.color.rgb }})">
                <span class="visually-hidden js-value">{{ value }}</span>
              </label>

            {%- else -%}
              <label class="opt-label {% if is_swatch_style %}opt-label--swatch{% else %}opt-label--btn{% endif %} btn relative text-center"{% if is_swatch_style %} data-swatch="{{ value | replace: '"', '' | downcase }}"{% endif %} for="{{ option_id }}-opt-{{ value_index0 }}">
                <span{% if is_swatch_style %} class="visually-hidden js-value"{% endif %}>{{ value }}</span>
              </label>

            {%- endif -%}
          {%- endfor -%}
        </div>
      </fieldset>
    {%- endif -%}

    {%- if show_size_chart -%}
      <modal-dialog class="modal invisible fixed top-0 left-0 w-full h-full flex items-center justify-center" id="size-chart">
        <div class="modal__window relative bg-theme-bg text-theme-text text-start overflow-hidden has-motion" role="dialog" aria-label="{{ pages[block.settings.size_chart_page].title }}" aria-modal="true" tabindex="-1">
          <button type="button" class="modal__close-btn absolute js-close-modal">
            {% render 'icon-close' %}
            <span class="visually-hidden">{{ 'accessibility.close' | t }}</span>
          </button>
          <div class="modal__content flex-auto h-full rte">
            {{ pages[block.settings.size_chart_page].content }}
          </div>
        </div>
      </modal-dialog>
    {%- endif -%}
  {%- endfor -%}

  <script type="application/json">
    {"variants": {{- product.variants | json -}},"formatted": {
      {%- for variant in product.variants -%}
        "{{ variant.id }}":{"price":{% if settings.show_currency_code %}{{ variant.price | money_with_currency | json }}{% else %}{{ variant.price | money | json }}{% endif %}
          {%- if variant.compare_at_price > variant.price -%}
            ,"compareAtPrice":{{ variant.compare_at_price | money | json -}}
          {%- endif -%}
          {%- if variant.unit_price_measurement -%}
            ,"unitPrice":{{ variant.unit_price | money | json -}}
          {%- endif -%}
          {%- if variant.inventory_management != nil and variant.inventory_quantity <= 0 -%}
            ,"inventory":"none"
          {%- endif -%}
        }{%- unless forloop.last %},{% endunless -%}
      {%- endfor -%}
    }}
  </script>
</variant-picker>

<noscript>
  <div class="product-info__select"{% if product.has_only_default_variant %} hidden{% endif %}>
    <label class="label" for="variants-{{ section.id }}">
      {{- 'products.product.product_variants' | t -}}
    </label>
    <div class="select relative">
      <select class="select w-full" id="variants-{{ section.id }}" name="id" form="{{ product_form_id }}">
        {%- for variant in product.variants -%}
          <option value="{{ variant.id }}"
                  {% if variant == current_variant %}selected{% endif %}
                  {% if variant.available == false %}disabled{% endif %}>
            {{- variant.title -}}
            {%- if variant.available == false %} - {{ 'products.product.sold_out' | t }}{% endif %}
            - {{ variant.price | money | strip_html }}
          </option>
        {%- endfor -%}
      </select>
    </div>
  </div>
</noscript>
